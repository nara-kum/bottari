<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="checkout">
	
	<!-- 일반 구매일 때 -->
	<select id="selectList" resultType="com.example.vo.CheckOutVO">
		<![CDATA[
			SELECT	c.cart_no,
					c.user_no,
			        c.product_no,
			        c.quantity,
			        co.detailoption_no,
			        p.title,
			        p.price,
			        p.brand,
			        p.itemimg,
			        p.shipping_cost,
			        po.option_no,
			        po.option_name,
			        (p.price * c.quantity) AS total_price,
			        SUM(c.quantity) OVER(PARTITION BY c.user_no) AS total_quantity,
			        SUM(c.quantity * p.price) OVER(PARTITION BY c.user_no) AS total_amount
			FROM cart c
			LEFT JOIN cart_option co ON c.cart_no = co.cart_no
			LEFT JOIN product p ON c.product_no = p.product_no
			LEFT JOIN product_option po ON c.product_no = po.product_no
			WHERE c.cart_no IN
		]]>
		<foreach collection="list" item="cartNos" open="(" close=")" separator=",">
			#{cartNos}
		</foreach>
	</select>
	
	<select id="selectDetail" resultType="com.example.vo.DetailOptionVO">
		<![CDATA[
			SELECT	co.detailoption_no,
			        od.detailoption_name
			FROM cart_option co
			LEFT JOIN option_detail od ON co.detailoption_no = od.detailoption_no
			WHERE cart_no IN
		]]>
		<foreach collection="list" item="cartNos" open="(" close=")" separator=",">
			#{cartNos}
		</foreach>
	</select>
	
	<!-- 펀딩 구매일 때 -->
	<select id="selectFundingList" resultType="com.example.vo.CheckoutFundingVO">
		<![CDATA[
			SELECT	fp.funding_no,
					fp.product_no,
			        fp.percent,
			        fp.amount,
			        fp.funding_status,
			        fo.detailoption_no,
			        od.detailoption_name,
			        p.title,
			        p.brand,
			        p.price,
			        p.itemimg,
			FROM funding_product fp
			LEFT JOIN funding_option fo ON fp.funding_no = fo.funding_no
			LEFT JOIN option_detail od ON fo.detailoption_no = od.detailoption_no
			LEFT JOIN product p ON fp.product_no = p.product_no
			WHERE funding_no = #{funding_no}
		]]>
	</select>
	
	<!-- 주소 가져오기 -->
	<select id="selectAddress" resultType="com.example.vo.CheckAddressVO">
		<![CDATA[
			SELECT	product_no,
					shipping_yn,
					zipcode,
			        address,
			        detail_address
			FROM product
			WHERE product_no IN
		]]>
		<foreach collection="list" item="productIdList" open="(" close=")" separator=",">
			#{productIdList}
		</foreach>
	</select>
	
	<insert id="insertpaymentList" parameterType="com.example.vo.PaymentVO" useGeneratedKeys="true" keyProperty="payment_no">
		<![CDATA[
			INSERT INTO payment (user_no, product_no, order_no, zipcode, address, detail_address, payment_date, payment_method, payment_status, delivery_status, payment_amount, service_type)
			VALUES(#{user_no}, #{product_no}, #{order_no}, #{zipcode}, #{address}, #{detail_address}, NOW(), #{payment_method}, #{payment_status}, #{delivery_status}, #{payment_amount}, #{service_type})
		]]>
	</insert>
	
	<insert id="insertpaymentgoodsList" parameterType="com.example.vo.PaymentVO" useGeneratedKeys="true" keyProperty="payment_goods_no">
		<![CDATA[
			INSERT INTO payment_goods (payment_no, product_no, quantity)
			VALUES(#{payment_no}, #{product_no}, #{quantity})
		]]>
	</insert>
	
	<insert id="insertpaymentgoodsoptionList" parameterType="com.example.vo.PaymentVO">
		<![CDATA[
			INSERT INTO payment_goods_option (payment_goods_no, detailoption_no)
			VALUES(#{payment_goods_no}, #{detailoption_no})
		]]>
	</insert>

</mapper>