<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cart">

	<select id="selectCartList"
		resultType="com.example.vo.CartListVO">
		<![CDATA[
			SELECT	c.cart_no,
					c.product_no,
			        c.quantity,
			        p.title,
			        p.brand,
			        p.itemimg,
			        p.price,
			        p.shipping_cost,
			        co.detailoption_no,
			        SUM(c.quantity) OVER(partition by c.user_no) AS total_quantity,
			        SUM(p.price * c.quantity) OVER(partition by c.user_no) AS total_price
			FROM cart c
			LEFT JOIN product p ON c.product_no = p.product_no
			LEFT JOIN cart_option co ON c.cart_no = co.cart_no
			WHERE user_no = #{user_no}
		]]>
	</select>

	<select id="selectByProductNoList"
		resultType="com.example.vo.ProductOptionListVO">
		<![CDATA[
			SELECT	po.product_no,
					po.option_no,
			        po.option_name,
			        od.detailoption_no,
			        od.detailoption_name
			FROM product_option po
			LEFT JOIN option_detail od ON po.option_no = od.option_no
			WHERE product_no IN 
		]]>
		<foreach collection="list" item="productNo" open="(" close=")" separator=",">
			#{productNo}
		</foreach>
	</select>
	
	<update id="updateCartQuantity">
		update cart
		set quantity = #{newQuantityValue}
		where cart_no = #{cart_no}
	</update>
	
	<update id="updateCartOptions">
		update cart_option
		set detailoption_no = #{option_no}
		where cart_no = #{cart_no}
	</update>
	
	<update id="updateCartAnniversary">
		update cart
		set category_no = #{event_no}
		where cart_no = #{cart_no}
	</update>
	
	<delete id="deleteCartItem">
		delete from cart
		where cart_no = #{cart_no}
	</delete>
	
	<!-- ✅ cart_option 선삭제 (FK/제약 대비) -->
	<delete id="deleteCartOptionsByCartNos">
	  DELETE FROM cart_option
	  WHERE cart_no IN
	  <foreach collection="list" item="cartNo" open="(" close=")" separator=",">
	    #{cartNo}
	  </foreach>
	</delete>
	
	<!-- ✅ cart 다건 삭제 -->
	<delete id="deleteCartItems">
	  DELETE FROM cart
	  WHERE cart_no IN
	  <foreach collection="list" item="cartNo" open="(" close=")" separator=",">
	    #{cartNo}
	  </foreach>
	</delete>
</mapper>