<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="history">
	<select id="searchPaymentList" resultType="com.example.vo.HistoryListVO">
		<![CDATA[
			SELECT	DATE(payment_date) AS payment_date,
					payment_no,
					funding_no,
					user_no
					FROM payment
			WHERE user_no = #{user_no}
			ORDER BY payment_date desc, payment_no DESC
		]]>
	</select>

	<select id="searchDetailList" resultType="com.example.vo.HistoryProductDetailVO">
		<![CDATA[
		  SELECT	pm.payment_no,
					pm.order_no,
			        pm.product_no,
			        pm.funding_no,
			        DATE(pm.payment_date) AS payment_date,
			        pm.delivery_status,
			        pm.payment_amount,
			        pm.service_type,
			        pg.quantity,
			        p.brand,
			        p.title,
			        p.price,
			        p.itemimg,
			        p.shipping_cost
			FROM payment pm
			LEFT JOIN product p ON pm.product_no = p.product_no
			LEFT JOIN payment_goods pg ON pm.payment_no = pg.payment_no
			WHERE pm.payment_no IN
		]]>
		<foreach collection="list" item="paymentNoList" open="(" close=")" separator=",">
			#{paymentNoList}
		</foreach>
	</select>
	
	<select id="searchFundingDetail" resultType="com.example.vo.HistoryFundingDetailVO">
		<![CDATA[
			SELECT	fp.funding_no,
					fp.percent,
					fp.amount,
			        fp.funding_status
			FROM funding_product fp
			WHERE fp.funding_no IN
		]]>
		<foreach collection="list" item="fundingNoList" open="(" close=")" separator=",">
			#{fundingNoList}
		</foreach>
	</select>
	
	<select id="selectHistoryDetail" resultType="com.example.vo.HistoryVO">
		<![CDATA[
			SELECT	pm.order_no,
					pm.funding_no,
					pm.product_no,
			        pm.zipcode,
			        pm.address,
			        pm.detail_address,
			        pm.payment_date,
			        pm.payment_method,
			        pm.payment_status,
			        pm.delivery_status,
			        pm.payment_amount,
			        pg.quantity,
			        p.title,
			        p.brand,
			        p.price,
			        p.itemimg
			FROM payment pm
			LEFT JOIN payment_goods pg ON pm.payment_no = pg.payment_no
			LEFT JOIN product p ON pm.product_no = p.product_no
			WHERE pm.order_no = #{order_no}
		]]>
	</select>
	
	<select id="selectfundingPercent" resultType="com.example.vo.HistoryFundingCheckVO">
		<![CDATA[
			select	fp.funding_no,
					fp.percent,
			        pg.quantity,
			        SUM(fp.percent * pg.quantity) OVER(partition by fp.funding_no) AS total_percent
			from funding_product fp
			left join payment p on fp.funding_no = p.funding_no
			left join payment_goods pg on p.payment_no = pg.payment_no
			where fp.funding_no = #{funding_no}
			and p.payment_status = "paid"
		]]>
	</select>

</mapper>